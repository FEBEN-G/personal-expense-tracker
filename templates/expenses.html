{% extends "base.html" %}

{% block title %}Expenses - ExpenseTracker{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
        <div class="text-center sm:text-left">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Expenses</h1>
            <p class="text-gray-600 text-sm sm:text-base mt-1">Manage your expenses and track your spending</p>
        </div>
        <button onclick="openExpenseModal()" class="bg-purple-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-purple-700 transition flex items-center justify-center space-x-2 w-full sm:w-auto">
            <i class="fas fa-plus"></i>
            <span class="text-sm sm:text-base">Add Expense</span>
        </button>
    </div>

    <!-- Add Expense Modal -->
    <div id="expenseModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-4 sm:top-20 mx-auto p-4 sm:p-5 border w-full sm:w-96 shadow-lg rounded-md bg-white m-4">
            <div class="mt-3">
                <h3 id="modalTitle" class="text-lg font-medium text-gray-900 mb-4">Add New Expense</h3>
                
                <form id="expenseForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <input type="text" id="expenseDescription" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Amount</label>
                        <input type="number" step="0.01" id="expenseAmount" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="expenseCategory" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base" required>
                            <option value="">Loading categories...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="expenseDate" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base" required>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 pt-3">
                        <button type="button" onclick="closeExpenseModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-400 text-sm sm:text-base">
                            Cancel
                        </button>
                        <button type="submit" id="submitButton" class="flex-1 bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 text-sm sm:text-base">
                            Add Expense
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Expenses Table -->
    <div class="bg-white rounded-xl shadow-sm">
        <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">Recent Expenses</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Category</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden xs:table-cell">Date</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="expensesTable">
                    <tr>
                        <td colspan="5" class="px-4 sm:px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-receipt text-3xl sm:text-4xl text-gray-300 mb-2"></i>
                                <p class="text-sm sm:text-base mb-4">Loading expenses...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<script>
// Global variables - only declare once
let authToken = null;
let currentEditingExpenseId = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Initialize auth token
    authToken = localStorage.getItem('authToken');
    
    // Check authentication
    if (!authToken) {
        window.location.href = '/login/';
        return;
    }
    
    // Load initial data
    loadExpenses();
    
    // Set up form submission
    const expenseForm = document.getElementById('expenseForm');
    if (expenseForm) {
        expenseForm.addEventListener('submit', function(event) {
            submitExpense(event);
        });
    }
    
    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('expenseModal');
        if (event.target === modal) {
            closeExpenseModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeExpenseModal();
        }
    });
});

// Authentication check
function checkAuth() {
    if (!authToken) {
        alert('Please login first');
        window.location.href = '/login/';
        return false;
    }
    return true;
}

// API request helper with auth
async function apiRequest(url, options = {}) {
    if (!authToken) {
        throw new Error('Not authenticated');
    }
    
    const defaultOptions = {
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Token ${authToken}`
        }
    };
    
    const finalOptions = {
        ...defaultOptions,
        ...options,
        headers: {
            ...defaultOptions.headers,
            ...options.headers
        }
    };
    
    const response = await fetch(url, finalOptions);
    return response;
}

// Modal functions
function openExpenseModal(expenseId = null) {
    const modal = document.getElementById('expenseModal');
    const modalTitle = document.getElementById('modalTitle');
    const submitButton = document.getElementById('submitButton');
    
    if (!modal || !modalTitle || !submitButton) {
        console.error('Modal elements not found');
        return;
    }
    
    modal.classList.remove('hidden');
    currentEditingExpenseId = expenseId;
    
    // Set today's date as default
    const dateInput = document.getElementById('expenseDate');
    if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // If editing, load expense data
    if (expenseId) {
        loadExpenseForEdit(expenseId);
        modalTitle.textContent = 'Edit Expense';
        submitButton.textContent = 'Update Expense';
    } else {
        const expenseForm = document.getElementById('expenseForm');
        if (expenseForm) {
            expenseForm.reset();
        }
        modalTitle.textContent = 'Add New Expense';
        submitButton.textContent = 'Add Expense';
    }
    
    loadCategoriesForDropdown();
}

function closeExpenseModal() {
    const modal = document.getElementById('expenseModal');
    if (modal) {
        modal.classList.add('hidden');
    }
    
    const expenseForm = document.getElementById('expenseForm');
    if (expenseForm) {
        expenseForm.reset();
    }
    currentEditingExpenseId = null;
}

// Load categories for dropdown
async function loadCategoriesForDropdown() {
    try {
        const response = await apiRequest('/api/categories/');
        if (response.ok) {
            const data = await response.json();
            console.log('Categories API response:', data);
            
            // Handle different response formats
            let categories = [];
            if (Array.isArray(data)) {
                categories = data;
            } else if (data.results && Array.isArray(data.results)) {
                categories = data.results;
            } else if (data.data && Array.isArray(data.data)) {
                categories = data.data;
            } else {
                console.error('Unexpected categories response format:', data);
                categories = [];
            }
            
            const categorySelect = document.getElementById('expenseCategory');
            
            if (!categorySelect) {
                console.error('Category select element not found');
                return;
            }
            
            categorySelect.innerHTML = '<option value="">Select a category</option>';
            
            if (categories.length === 0) {
                categorySelect.innerHTML = '<option value="">No categories available. Please create a category first.</option>';
                return;
            }
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        } else {
            console.error('Failed to load categories:', response.status);
            const categorySelect = document.getElementById('expenseCategory');
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">Error loading categories</option>';
            }
        }
    } catch (error) {
        console.error('Error loading categories:', error);
        const categorySelect = document.getElementById('expenseCategory');
        if (categorySelect) {
            categorySelect.innerHTML = '<option value="">Error loading categories</option>';
        }
    }
}

// Load expense data for editing
async function loadExpenseForEdit(expenseId) {
    try {
        const response = await apiRequest(`/api/expenses/${expenseId}/`);
        if (response.ok) {
            const expense = await response.json();
            const descInput = document.getElementById('expenseDescription');
            const amountInput = document.getElementById('expenseAmount');
            const categorySelect = document.getElementById('expenseCategory');
            const dateInput = document.getElementById('expenseDate');
            
            if (descInput) descInput.value = expense.description;
            if (amountInput) amountInput.value = expense.amount;
            if (categorySelect) categorySelect.value = expense.category;
            if (dateInput) dateInput.value = expense.date;
        }
    } catch (error) {
        console.error('Error loading expense:', error);
        alert('Error loading expense data');
    }
}

// Submit expense to API
async function submitExpense(event) {
    // Prevent default only if event exists (form submission)
    if (event && event.preventDefault) {
        event.preventDefault();
    }
    
    if (!checkAuth()) return;

    const descInput = document.getElementById('expenseDescription');
    const amountInput = document.getElementById('expenseAmount');
    const categorySelect = document.getElementById('expenseCategory');
    const dateInput = document.getElementById('expenseDate');
    
    if (!descInput || !amountInput || !categorySelect || !dateInput) {
        alert('Form elements not found');
        return;
    }

    const expenseData = {
        description: descInput.value.trim(),
        amount: parseFloat(amountInput.value),
        category: parseInt(categorySelect.value),
        date: dateInput.value
    };

    // Validation
    if (!expenseData.description) {
        alert('Description is required');
        return;
    }

    if (!expenseData.amount || expenseData.amount <= 0) {
        alert('Amount must be greater than 0');
        return;
    }

    if (!expenseData.category) {
        alert('Please select a category');
        return;
    }

    if (!expenseData.date) {
        alert('Date is required');
        return;
    }

    try {
        let response;
        if (currentEditingExpenseId) {
            // Update existing expense
            response = await apiRequest(`/api/expenses/${currentEditingExpenseId}/`, {
                method: 'PUT',
                body: JSON.stringify(expenseData)
            });
        } else {
            // Create new expense
            response = await apiRequest('/api/expenses/', {
                method: 'POST',
                body: JSON.stringify(expenseData)
            });
        }

        if (response.ok) {
            closeExpenseModal();
            await loadExpenses();
            alert(currentEditingExpenseId ? 'Expense updated successfully!' : 'Expense added successfully!');
        } else {
            const errorData = await response.json();
            console.error('API Error:', errorData);
            
            if (errorData.description && errorData.description[0]) {
                alert('Error: ' + errorData.description[0]);
            } else if (errorData.amount && errorData.amount[0]) {
                alert('Error: ' + errorData.amount[0]);
            } else if (errorData.category && errorData.category[0]) {
                alert('Error: ' + errorData.category[0]);
            } else if (errorData.detail) {
                alert('Error: ' + errorData.detail);
            } else {
                alert('Error: ' + JSON.stringify(errorData));
            }
        }
    } catch (error) {
        console.error('Error submitting expense:', error);
        alert('Error: ' + error.message);
    }
}

// Load expenses from API
async function loadExpenses() {
    if (!checkAuth()) return;

    try {
        const response = await apiRequest('/api/expenses/');
        
        if (response.ok) {
            const data = await response.json();
            console.log('Expenses API response:', data);
            
            // Handle different response formats
            let expenses = [];
            if (Array.isArray(data)) {
                expenses = data;
            } else if (data.results && Array.isArray(data.results)) {
                expenses = data.results;
            } else if (data.data && Array.isArray(data.data)) {
                expenses = data.data;
            } else {
                console.error('Unexpected expenses response format:', data);
                expenses = [];
            }
            
            const tableBody = document.getElementById('expensesTable');
            
            if (!tableBody) {
                console.error('Expenses table body not found');
                return;
            }
            
            if (expenses.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-receipt text-4xl text-gray-300 mb-2"></i>
                                <p class="mb-4">No expenses found</p>
                                <button onclick="openExpenseModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                    Add your first expense
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = '';
            
            expenses.forEach(expense => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${expense.description}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ${expense.category_name || 'Uncategorized'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        $${parseFloat(expense.amount).toFixed(2)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(expense.date).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editExpense(${expense.id})" class="text-purple-600 hover:text-purple-900 mr-4 transition-colors">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button onclick="deleteExpense(${expense.id})" class="text-red-600 hover:text-red-900 transition-colors">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        } else if (response.status === 401) {
            window.location.href = '/login/';
        } else {
            console.error('Failed to load expenses:', response.status);
            const errorText = await response.text();
            console.error('Error details:', errorText);
            
            const tableBody = document.getElementById('expensesTable');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-2"></i>
                                <p class="mb-2">Error loading expenses</p>
                                <p class="text-sm text-gray-400">Please try refreshing the page</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    } catch (error) {
        console.error('Error loading expenses:', error);
        if (error.message === 'Not authenticated') {
            window.location.href = '/login/';
        } else {
            const tableBody = document.getElementById('expensesTable');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-2"></i>
                                <p class="mb-2">Network error</p>
                                <p class="text-sm text-gray-400">Please check your connection</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
}

// Edit expense function
function editExpense(expenseId) {
    openExpenseModal(expenseId);
}

// Delete expense function
async function deleteExpense(expenseId) {
    if (!checkAuth()) return;

    if (!confirm('Are you sure you want to delete this expense? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await apiRequest(`/api/expenses/${expenseId}/`, {
            method: 'DELETE'
        });

        if (response.ok) {
            await loadExpenses();
            alert('Expense deleted successfully!');
        } else if (response.status === 404) {
            alert('Expense not found');
        } else {
            const errorData = await response.json();
            alert('Error deleting expense: ' + (errorData.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting expense:', error);
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}