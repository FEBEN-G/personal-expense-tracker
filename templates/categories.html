{% extends "base.html" %}

{% block title %}Categories - ExpenseTracker{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Categories</h1>
            <p class="text-gray-600">Organize your expenses with categories</p>
        </div>
        <button onclick="openCategoryModal()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition flex items-center space-x-2">
            <i class="fas fa-plus"></i>
            <span>Add Category</span>
        </button>
    </div>

    <!-- Add Category Modal -->
    <div id="categoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 id="modalTitle" class="text-lg font-medium text-gray-900 mb-4">Add New Category</h3>
                
                <form id="categoryForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category Name</label>
                        <input type="text" id="categoryName" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., Food, Transport, etc." required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="categoryDescription" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Optional description"></textarea>
                    </div>
                    
                    <div class="flex space-x-3 pt-3">
                        <button type="button" onclick="closeCategoryModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" id="submitButton" class="flex-1 bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700">
                            Add Category
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Categories Table -->
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expenses</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="categoriesTable" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-folder-open text-4xl text-gray-300 mb-2"></i>
                            <p class="mb-4">Loading categories...</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
// Global variables - only declare once
let authToken = null;
let currentEditingCategoryId = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Initialize auth token
    authToken = localStorage.getItem('authToken');
    
    // Check authentication
    if (!authToken) {
        console.log('No auth token, redirecting to login');
        window.location.href = '/login/';
        return;
    }
    
    console.log('User authenticated, loading categories...');
    
    // Load initial data
    loadCategories();
    
    // Set up form submission
    const categoryForm = document.getElementById('categoryForm');
    if (categoryForm) {
        categoryForm.addEventListener('submit', function(event) {
            submitCategory(event);
        });
        console.log('Form submission handler attached');
    } else {
        console.error('Category form not found');
    }
    
    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('categoryModal');
        if (event.target === modal) {
            closeCategoryModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeCategoryModal();
        }
    });
    
    console.log('Categories page initialization complete');
});

// Debug function to check what's happening
function debugCategories() {
    console.log('Auth Token:', authToken);
    console.log('Current Editing ID:', currentEditingCategoryId);
}

// Authentication check
function checkAuth() {
    if (!authToken) {
        alert('Please login first');
        window.location.href = '/login/';
        return false;
    }
    return true;
}

// API request helper with auth
async function apiRequest(url, options = {}) {
    if (!authToken) {
        throw new Error('Not authenticated');
    }
    
    const defaultOptions = {
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Token ${authToken}`
        }
    };
    
    const finalOptions = {
        ...defaultOptions,
        ...options,
        headers: {
            ...defaultOptions.headers,
            ...options.headers
        }
    };
    
    console.log('Making API request to:', url);
    const response = await fetch(url, finalOptions);
    console.log('API response status:', response.status);
    return response;
}

// Modal functions
function openCategoryModal(categoryId = null) {
    console.log('Opening category modal for:', categoryId);
    document.getElementById('categoryModal').classList.remove('hidden');
    currentEditingCategoryId = categoryId;
    
    const modalTitle = document.getElementById('modalTitle');
    const submitButton = document.getElementById('submitButton');
    
    if (categoryId) {
        loadCategoryForEdit(categoryId);
        if (modalTitle) modalTitle.textContent = 'Edit Category';
        if (submitButton) submitButton.textContent = 'Update Category';
    } else {
        document.getElementById('categoryForm').reset();
        if (modalTitle) modalTitle.textContent = 'Add New Category';
        if (submitButton) submitButton.textContent = 'Add Category';
    }
}

function closeCategoryModal() {
    console.log('Closing category modal');
    document.getElementById('categoryModal').classList.add('hidden');
    document.getElementById('categoryForm').reset();
    currentEditingCategoryId = null;
}

// Load category data for editing
async function loadCategoryForEdit(categoryId) {
    try {
        console.log('Loading category for edit:', categoryId);
        const response = await apiRequest(`/api/categories/${categoryId}/`);
        if (response.ok) {
            const category = await response.json();
            console.log('Category data loaded:', category);
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryDescription').value = category.description || '';
        } else {
            console.error('Failed to load category:', response.status);
            alert('Failed to load category data');
        }
    } catch (error) {
        console.error('Error loading category:', error);
        alert('Error loading category data: ' + error.message);
    }
}

// Submit category to API
async function submitCategory(event) {
    console.log('Submitting category form');
    
    // Prevent default only if event exists (form submission)
    if (event && event.preventDefault) {
        event.preventDefault();
    }
    
    if (!checkAuth()) return;

    const categoryData = {
        name: document.getElementById('categoryName').value.trim(),
        description: document.getElementById('categoryDescription').value.trim()
    };

    console.log('Category data to submit:', categoryData);

    // Validation
    if (!categoryData.name) {
        alert('Category name is required');
        return;
    }

    try {
        let response;
        if (currentEditingCategoryId) {
            // Update existing category
            console.log('Updating category:', currentEditingCategoryId);
            response = await apiRequest(`/api/categories/${currentEditingCategoryId}/`, {
                method: 'PUT',
                body: JSON.stringify(categoryData)
            });
        } else {
            // Create new category
            console.log('Creating new category');
            response = await apiRequest('/api/categories/', {
                method: 'POST',
                body: JSON.stringify(categoryData)
            });
        }

        console.log('Submit response status:', response.status);
        
        if (response.ok) {
            const responseData = await response.json();
            console.log('Category operation successful:', responseData);
            
            closeCategoryModal();
            await loadCategories();
            alert(currentEditingCategoryId ? 'Category updated successfully!' : 'Category added successfully!');
        } else {
            const errorData = await response.json();
            console.error('API Error response:', errorData);
            
            if (errorData.name && errorData.name[0]) {
                alert('Error: ' + errorData.name[0]);
            } else if (errorData.detail) {
                alert('Error: ' + errorData.detail);
            } else if (errorData.non_field_errors) {
                alert('Error: ' + errorData.non_field_errors[0]);
            } else {
                alert('Error: ' + JSON.stringify(errorData));
            }
        }
    } catch (error) {
        console.error('Error submitting category:', error);
        alert('Error: ' + error.message);
    }
}

// Load categories from API
async function loadCategories() {
    console.log('Loading categories...');
    if (!checkAuth()) return;

    try {
        const response = await apiRequest('/api/categories/');
        console.log('Categories response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Categories API response:', data);
            
            // Handle different response formats
            let categories = [];
            if (Array.isArray(data)) {
                categories = data;
            } else if (data.results && Array.isArray(data.results)) {
                categories = data.results;
            } else if (data.data && Array.isArray(data.data)) {
                categories = data.data;
            } else {
                console.error('Unexpected categories response format:', data);
                categories = [];
            }
            
            const tableBody = document.getElementById('categoriesTable');
            
            if (!tableBody) {
                console.error('Categories table not found');
                return;
            }
            
            console.log('Categories array length:', categories.length);
            
            if (!categories || categories.length === 0) {
                console.log('No categories found');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-folder-open text-4xl text-gray-300 mb-2"></i>
                                <p class="mb-4">No categories found</p>
                                <button onclick="openCategoryModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                    Create your first category
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            console.log('Rendering categories:', categories.length);
            tableBody.innerHTML = '';
            
            categories.forEach(category => {
                console.log('Rendering category:', category);
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                // Use data from API or calculate defaults
                const expenseCount = category.expense_count || 0;
                const totalExpenses = category.total_expenses || 0;
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${category.name}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-500 max-w-xs truncate">${category.description || 'No description'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${expenseCount} expenses
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        $${parseFloat(totalExpenses).toFixed(2)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editCategory(${category.id})" class="text-purple-600 hover:text-purple-900 mr-4 transition-colors">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button onclick="deleteCategory(${category.id})" class="text-red-600 hover:text-red-900 transition-colors">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        } else if (response.status === 401) {
            console.log('Unauthorized, redirecting to login');
            window.location.href = '/login/';
        } else {
            console.error('Failed to load categories:', response.status);
            const errorData = await response.json();
            console.error('Error details:', errorData);
            
            const tableBody = document.getElementById('categoriesTable');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-2"></i>
                                <p class="mb-2">Error loading categories</p>
                                <p class="text-sm text-gray-400">Status: ${response.status}</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    } catch (error) {
        console.error('Error loading categories:', error);
        if (error.message === 'Not authenticated') {
            window.location.href = '/login/';
        } else {
            const tableBody = document.getElementById('categoriesTable');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-2"></i>
                                <p class="mb-2">Network error</p>
                                <p class="text-sm text-gray-400">Please check your connection</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    }
}

// Edit category function
function editCategory(categoryId) {
    console.log('Editing category:', categoryId);
    openCategoryModal(categoryId);
}

// Delete category function
async function deleteCategory(categoryId) {
    console.log('Deleting category:', categoryId);
    if (!checkAuth()) return;

    if (!confirm('Are you sure you want to delete this category? Any expenses in this category will become uncategorized.')) {
        return;
    }

    try {
        const response = await apiRequest(`/api/categories/${categoryId}/`, {
            method: 'DELETE'
        });

        console.log('Delete response status:', response.status);
        
        if (response.ok) {
            await loadCategories();
            alert('Category deleted successfully!');
        } else if (response.status === 404) {
            alert('Category not found');
        } else if (response.status === 400) {
            alert('Cannot delete category. It may have associated expenses.');
        } else {
            const errorData = await response.json();
            alert('Error deleting category: ' + (errorData.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting category:', error);
        alert('Error: ' + error.message);
    }
}

// Add debug function to global scope for testing
window.debugCategories = debugCategories;
</script>
{% endblock %}