<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ExpenseTracker{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .mobile-menu {
            transition: all 0.3s ease;
        }
        .footer-fixed {
            margin-top: auto;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    {% if not hide_navigation %}
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <!-- Logo -->
                <div class="flex items-center space-x-2">
                    <i class="fas fa-wallet text-purple-600 text-2xl"></i>
                    <span class="text-xl font-bold text-gray-800 hidden sm:block">ExpenseTracker</span>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex space-x-4 items-center">
                    <a href="/dashboard/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                    <a href="/expenses/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-sm font-medium">Expenses</a>
                    <a href="/categories/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-sm font-medium">Categories</a>
                    <a href="/analytics/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-sm font-medium">Analytics</a>
                    <a href="/api/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-sm font-medium">API</a>
                    <a href="/admin/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-sm font-medium">Admin</a>
                    
                    <!-- Logout Button -->
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'logout' %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm font-medium">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </form>
                    {% else %}
                    <a href="/login/" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm font-medium">
                        Login
                    </a>
                    {% endif %}
                </div>

                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button type="button" onclick="toggleMobileMenu()" class="text-gray-600 hover:text-purple-600 focus:outline-none focus:text-purple-600">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobileMenu" class="mobile-menu hidden md:hidden pb-4 border-t border-gray-200">
                <div class="flex flex-col space-y-2 mt-2">
                    <a href="/dashboard/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-base font-medium">Dashboard</a>
                    <a href="/expenses/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-base font-medium">Expenses</a>
                    <a href="/categories/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-base font-medium">Categories</a>
                    <a href="/analytics/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-base font-medium">Analytics</a>
                    <a href="/api/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-base font-medium">API</a>
                    <a href="/admin/" class="text-gray-600 hover:text-purple-600 transition px-3 py-2 rounded-md text-base font-medium">Admin</a>
                    
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'logout' %}" class="px-3 py-2">
                        {% csrf_token %}
                        <button type="submit" class="bg-red-600 text-white w-full px-4 py-2 rounded-lg hover:bg-red-700 transition text-base font-medium">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </form>
                    {% else %}
                    <a href="/login/" class="bg-purple-600 text-white text-center px-4 py-2 rounded-lg hover:bg-purple-700 transition text-base font-medium mx-3">
                        Login
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Main Content -->
    <main class="flex-1 w-full">
        {% block content %}
        {% endblock %}
    </main>

    <!-- Footer -->
    {% if not hide_footer %}
    <footer class="bg-gray-800 text-white py-8 footer-fixed">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-gray-400 text-sm sm:text-base">&copy; 2024 ExpenseTracker. Built with Django REST Framework.</p>
        </div>
    </footer>
    {% endif %}

    <script>
        // Mobile menu toggle
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('hidden');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const mobileMenu = document.getElementById('mobileMenu');
            const menuButton = event.target.closest('button');
            
            if (!mobileMenu.contains(event.target) && menuButton === null) {
                mobileMenu.classList.add('hidden');
            }
        });

        // CSRF Token handling
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Authentication state
        let authToken = localStorage.getItem('authToken');
        let currentUser = localStorage.getItem('currentUser');

        // Update navigation based on auth state
        function updateNavigation() {
            const loginBtns = document.querySelectorAll('a[href="/login/"], .login-btn');
            if (authToken) {
                loginBtns.forEach(btn => {
                    btn.textContent = 'Logout';
                    btn.href = '#';
                    btn.onclick = logout;
                    btn.className = btn.className.replace('bg-purple-600', 'bg-red-600') + ' logout-btn';
                });
            }
        }

        // Login function
        async function login(username, password) {
            try {
                const response = await fetch('/api/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    currentUser = data.username;
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', currentUser);
                    
                    updateNavigation();
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Login error:', error);
                return false;
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            authToken = null;
            currentUser = null;
            updateNavigation();
            window.location.href = '/';
        }

        // API request helper with auth
        async function apiRequest(url, options = {}) {
            if (authToken) {
                options.headers = {
                    ...options.headers,
                    'Authorization': `Token ${authToken}`
                };
            }
            
            const response = await fetch(url, options);
            return response;
        }

        // Update navigation on page load
        document.addEventListener('DOMContentLoaded', updateNavigation);
    </script>
</body>
</html>